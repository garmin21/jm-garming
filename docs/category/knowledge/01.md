---
title: web è°ƒèµ·æ‘„åƒå¤´ å¹¶æˆªå›¾ä¿å­˜
date: 2022-7-20
categories:
    - æ¡ˆä¾‹ç ”ç©¶
tags:
    - æ¡ˆä¾‹ç ”ç©¶
publish: true
---

ç”±äºæ˜¯åœ¨ å¼¹æ¡†ä¸­è¿›è¡Œæ‘„åƒ ï¼Œæ‰€ä»¥åˆå§‹åŒ–çš„ä»£ç æ”¾åœ¨ `updated`ä¸­, éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªé’©å­ä¸­ï¼Œå½“æ¨¡ç‰ˆä¸­çš„ä¾èµ–è¢«æ›´æ–°æ—¶ï¼Œéƒ½ä¼šè¢«è§¦å‘ ï¼Œæ‰€ä»¥å°±éœ€è¦åŠ é™åˆ¶ ğŸš«

```vue
<script>
export default {
    data: {
      // æ–°å¢é‡‡é›†åŠŸèƒ½å­—æ®µ
      CaiJIan: true, // æ˜¯å¦è£å‰ª
      shutter: null,
      canvas: null,
      context: null,
      video: null,
      mediaStreamTrack: null,
    },
    updated() {
        // é¡µé¢çš„æ‰€æœ‰ä¾èµ–æ›´æ–°éƒ½ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œæ‰€ä»¥è¿™é‡Œè¦å¼‚å¸¸å°å¿ƒ
        if(this.mediaStreamTrack) return; // å½“å¼¹æ¡†å…³é—­çš„æ—¶å€™ï¼Œä¸å»æ‰§è¡Œä¸‹é¢çš„é€»è¾‘
        this.video = this.$refs.videoRef
        if(this.video) {
        if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
            //è°ƒç”¨ç”¨æˆ·åª’ä½“è®¾å¤‡, è®¿é—®æ‘„åƒå¤´
            this.getUserMedia({ video: this.video }, this.success, this.error);
        } else {
                alert('ä¸æ”¯æŒè®¿é—®ç”¨æˆ·åª’ä½“');
        }
        // åª’ä½“çš„åŠ è½½å¿…é¡»è¦å¼•å…¥ä¸€ä¸ªåª’ä½“æ–‡ä»¶ï¼Œå¦åˆ™ä¸ä¼šç”Ÿæ•ˆ
        this.shutter = new Audio('./shutter.mp3')
        //   åˆå§‹åŒ– canvas ref
        this.canvas = this.$refs.canvasRef
        this.context = this.canvas.getContext('2d');
        }
    },
    methods: {
        getUserMedia(constraints, success, error) {
            if (navigator.mediaDevices.getUserMedia) {
                //æœ€æ–°çš„æ ‡å‡†API
                navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
            } else if (navigator.webkitGetUserMedia) {
                //webkitæ ¸å¿ƒæµè§ˆå™¨
                navigator.webkitGetUserMedia(constraints, success, error)
            } else if (navigator.mozGetUserMedia) {
                //firfoxæµè§ˆå™¨
                navigator.mozGetUserMedia(constraints, success, error);
            } else if (navigator.getUserMedia) {
                //æ—§ç‰ˆAPI
                navigator.getUserMedia(constraints, success, error);
            }
        },
        success(stream) {
            //å…¼å®¹webkitæ ¸å¿ƒæµè§ˆå™¨
            // let CompatibleURL = window.URL || window.webkitURL;
            //å°†è§†é¢‘æµè®¾ç½®ä¸ºvideoå…ƒç´ çš„æº
            //video.src = CompatibleURL.createObjectURL(stream);
            this.video.srcObject = stream;
            this.mediaStreamTrack = stream.getTracks()[0]
            this.video.play();
        },
        error(error) {
            console.log(`è®¿é—®ç”¨æˆ·åª’ä½“è®¾å¤‡å¤±è´¥${error.name}, ${error.message}`);
        },
            //å½©å›¾ï¼Œæ‹ç…§
    take_snapshot() {
      this.context.drawImage(this.video, 0, 0,  $(this.video).attr("width"), $(this.video).attr("height"));
      var img = new Image();
      img.src = this.canvas.toDataURL('image/jpeg', 1);

      if (this.CaiJIan) {
          img = this.caijianImg();
      }
        //   const file = this.base64ToFile(img.src, 'å›¾ç‰‡é‡‡é›†')
        //   const URL = this.getImageUrl({
        //     status: 'ready',
        //     name: file.name,
        //     szie: file.size,
        //     percentage: 0,
        //     raw: file
        //   })
        //   this.imgList.push({
        //     img: URL,
        //     show: false
        //   })
        //   this.fileList.push({
        //     status: 'ready',
        //     name: file.name,
        //     szie: file.size,
        //     percentage: 0,
        //     raw: file
        //   })
    },
    //å›¾ç‰‡è£å‰ª
    caijianImg() {
        var width = $(this.video).attr("width");
        var height = $(this.video).attr("height");

        // æ•´ä¸ªé‡‡é›†å›¾ç‰‡å‘å³åç§»å¤šå°‘ï¼Œä¹Ÿå°±æ˜¯å·¦è¾¹å¤šå°‘ä¸ªåƒç´ ä¸è¦äº†
        var sx = 100;
        // æ•´ä¸ªé‡‡é›†å›¾ç‰‡å‘ä¸Šåç§»å¤šå°‘ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¾¹å¤šå°‘ä¸ªåƒç´ ä¸è¦äº†
        var sy = 100;
        //ä¹Ÿå°±æ˜¯å³è¾¹å¤šå°‘ä¸ªåƒç´ ä¸è¦äº†
        var yby = 100;
        // ä¸‹è¾¹å¤šå°‘ä¸ªåƒç´ ä¸è¦äº†
        var xby = 100;


        var sWidth = width - sx;
        var sHeight = height - sy;

        var dWidth = width - sx;
        var dHeight = height - sy;

        var quality = 1;
        var dx = 0;
        var dy = 0;

        this.canvas.width = dWidth - yby;
        this.canvas.height = dHeight - xby;

        this.context.drawImage(this.video, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

        var preview = new Image();
        preview.src = this.canvas.toDataURL('image/jpeg', quality);;
        return preview;
    },
    base64ToFile(urlData, fileName) {
      let arr = urlData.split(',');
      let mime = arr[0].match(/:(.*?);/)[1];
      let bytes = atob(arr[1]); // è§£ç base64
      let n = bytes.length
      let ia = new Uint8Array(n);
      while (n--) {
          ia[n] = bytes.charCodeAt(n);
      }
      return new File([ia], fileName, { type: mime });
    },
    getImageUrl(file) {
      let URL = null;
      if(window.createObjectURL !== undefined) {
        URL = window.createObjectURL(file.raw)
      } else if(window.URL !== undefined) {
        URL = window.URL.createObjectURL(file.raw)
      } else if(window.webkitURL !== undefined) {
        URL = window.webkitURL.createObjectURL(file.raw)
      }
      return URL
    }
  }
},
</script>
```
