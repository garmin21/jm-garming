---
title: åŠ¨æ€è·¯ç”±
date: '2022-11-19'
categories:
  - æ¦‚å¿µ
tags:
  - æ¦‚å¿µ
publish: true
---

## åŠ¨æ€è·¯ç”±

è¯´ä¸€ä»¶å¾ˆè ¢çš„äº‹ï¼Œæˆ‘å¥½ä¹…æ²¡åšè¿‡åŠ¨æ€è·¯ç”±ï¼Œåœ¨å…¬å¸åŠå…¬æ—¶ï¼Œé‡åˆ°åç«¯å·²ç»å¸®æˆ‘å¤„ç†å¥½äº†ä¸€é¢—æ ‘ç»“æ„ç»™æˆ‘çš„æ•°æ®ï¼Œæˆ‘åªéœ€è¦è½¬ä¸º vue-router çš„ç»“æ„å°±è¡Œäº†ï¼Œç»“æœå¼„äº†åŠå¤©ï¼Œå¤´è„‘å‘çƒ­ã€‚ä½†æ˜¯å°±æ˜¯å¼„ä¸å‡ºæ¥ï¼Œè¿™ä¸€è‡³è®©æˆ‘è®¤ä¸ºæˆ‘æ˜¯ä¸æ˜¯ï¼Œsb äº† ğŸ˜­

## æ€»ç»“ä¸‹åŠ¨æ€è·¯ç”±æ˜¯æ€ä¹ˆåšçš„

åŠ¨æ€è·¯ç”±å°±æ˜¯å¾ˆç®€å•çš„ä¸€å¥è¯ï¼Œå°±æ˜¯æŠŠ åç«¯è¿”å›çš„ æ•°æ®ï¼Œå…ˆè½¬æ¢ä¸ºä¸€ä¸ª tree ï¼Œç„¶åï¼Œå†å°† tree ç”Ÿæˆ ä¸€ä¸ªè·¯ç”±çš„ tree, å°±è¿™ä¹ˆç®€å•ï¼Œ
åé¢å°±æ ¹æ®è¿™ä¸ªç”Ÿæˆçš„è·¯ç”±ï¼Œæ¸²æŸ“ èœå•ï¼Œä½ å¯ä»¥ä½¿ç”¨ element-ui è‡ªå¸¦çš„ï¼Œä¹Ÿå¯ä»¥ è‡ªå·±å†™ä¸€ä¸ª é€’å½’ç»„ä»¶ï¼Œ ä½†æ˜¯ä½ çš„æœ¬åœ°ï¼Œæ˜¯è¦æœ‰å¯¹åº”ç»“æ„ çš„.vue æ–‡ä»¶ï¼Œä¸èƒ½å…‰æœ‰ è·³è½¬è·¯å¾„ï¼Œæ²¡æœ‰æ–‡ä»¶

- åœ¨ vue-router 3.x ä¸­ä½ å¯ä»¥é€šè¿‡ router.addRoutes() å»æ·»åŠ åˆ° vue-router è·¯ç”±ä¸­å»

```js
export function generateRouters(data) {
  return Array.from(data).map((route) => {
    let _route = {}
    _route.name = route.name
    _route.path = route.urlAddr
    _route.icon = route.menuIcon
    _route.component = () => import(`@/views${route.name}`)

    if (route.children) {
      _route.children = generateRouters(route.children)
    }
    return _route
  })
}
router.addRoutes(generateRouters(data))
```

- vue-router 4x çš„ç‰ˆæœ¬å°±å»é™¤äº†è¿™ä¸ªæ–¹æ³• ï¼Œåªèƒ½é€šè¿‡`addRoute`ä¸€ä¸ªä¸€ä¸ªåŠ 

### 1. ç”Ÿæˆè·¯ç”±ç»“æ„æ–¹æ³•

```js
import { error_404 } from '@/routers.js'

export const loadView = (view) => {
  // è·¯ç”±æ‡’åŠ è½½
  return () => Promise.resolve(require(`@/views${view}`).default)
}

export const Layout = () => {
  // è·¯ç”±æ‡’åŠ è½½
  return () => Promise.resolve(require(`@/layout/index.vue`).default)
}

export function generateRouters(data) {
  if (!Array.isArray(data)) return data

  return Array.from(data)
    .map((route) => {
      let _route = {}
      _route = { ...route }

      if (route.children && route.children.length) {
        // çˆ¶çº§
        _route.path = `/${route.menuIcon}`
        _route.redirect = _route.path + `/${route.children[0].urlAddr}`
        _route.component = Layout()
        _route.children = generateRouters(route.children)
        _route.name = route.menuIcon
      } else {
        _route.path = route.urlAddr
        _route.component = loadView(route.component)
        _route.name = route.urlAddr
      }
      _route.meta = {}
      return _route
    })
    .concat([error_404])
}
```

### 2. åœ¨ store ä¸­ï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†

```js

const actions = {
 // get menu
 getMenu({ commit, state }, params) {
  state.menu_loading = true;
  getMenu(params)
   .then(result => {
    const routers = generateRouters(result.data ? result.data : []);
    routers.forEach(route => {
      // TODO: å°†è·¯ç”±æ·»åŠ è¿›å»
     router.addRoute(route);
    });
    commit('SET_MENU', routers);
   })
   .finally(() =>; (state.menu_loading = false));
 }
};
```

### 3. åœ¨å…¨å±€å®ˆå«ä¸­ï¼Œå‘é€è¯·æ±‚è·å–ï¼Œèœå•æ•°æ®

```js
router.beforeEach(async (to, from, next) => {
  const hasToken = store.getters.token

  if (hasToken) {
    if (to.path === '/login') {
      // if is logged in, redirect to the home page
      next({ path: '/' })
      NProgress.done()
    } else {
      const hasGetUserInfo = store.getters.name
      if (hasGetUserInfo) {
        next()
      } else {
        try {
          // TODO: å½“è·å–ç”¨æˆ·ä¿¡æ¯åï¼Œåœ¨è¯·æ±‚èœå•ä¿¡æ¯
          const { sysPostIds } = await store.dispatch('user/getInfo')
          if (sysPostIds[0] && !store.getters.menu.length) {
            store.dispatch('user/getMenu', {
              sysPostId: sysPostIds[0],
              type: 0,
            })
          }
          next()
        } catch (error) {
          // remove token and go to login page to re-login
          Message.error(error || 'Has Error')
          Storage.clear()
          store.commit('user/SET_TOKEN', default_token)
          next(`/login`)
          NProgress.done()
        }
      }
    }
  } else {
    /* has no token*/
    if (whiteList.indexOf(to.path) !== -1) {
      // in the free login whitelist, go directly
      next()
    } else {
      // other pages that do not have permission to access are redirected to the login page.
      next(`/login`)
      NProgress.done()
    }
  }
})
```

## ç”Ÿæˆæ ‘ç»“æ„çš„æ–¹å¼æœ‰å¾ˆå¤šç§

### 1. filter

```js
function arrToTree(souse) {
  if (!Array.isArray(souse)) {
    return souse
  }
  // å°†æ ¹èŠ‚ç‚¹0è¿”å›
  return souse.filter((node) => {
    // ä¸æ–­çš„å»å¯»æ‰¾å¯¹åº”çš„ä¸€ä¸ªå­èŠ‚ç‚¹
    const children = souse.filter((item) => {
      return node.id === item.pid
    })
    // å­èŠ‚ç‚¹æœ‰å€¼çš„è¯ï¼Œå°±ç›´æ¥ è®¾ç½® children ä¸ºæ‰¾åˆ°çš„ children
    if (children.length) {
      node.children = children
    }
    return node.pid === 0
  })
}
```

### 2. å»ºç«‹ ID æ˜ å°„ å…³ç³»

```js
function invertTrees(sourceArr) {
  let obj = {} // å»ºç«‹id å’Œå¯¹è±¡çš„å…³ç³»
  sourceArr.forEach((item) => (obj[item.id] = item))

  const result = []
  sourceArr.forEach((node) => {
    // æ ¹èŠ‚ç‚¹
    if (node.pid === 0) {
      return result.push(node)
    }

    // objé‡Œé¢ pid å»æ‰¾ id
    obj[node.pid].children = obj[node.pid].children || []
    // è¿™ä¸ªæ—¶å€™ node.pid å’Œ obj[id] æ˜¯ä¸€æ ·çš„ï¼Œ è¿™ä¸ªæ—¶å€™ï¼Œå°±æ˜¯å®ƒçš„å­é›†
    obj[node.pid].children.push(node)
  })

  return result
}
```

### 3. æ¢äº†ç§å†™å‘ ä¸ 2 åŒæ ·çš„æ€è·¯

```js
function convert(list) {
  const result = []
  const map = list.reduce((pre, cur) => {
    pre[cur.id] = cur
    return pre
  }, {})

  for (let item of list) {
    if (item.pid === 0) {
      result.push(item)
      continue
    }
    if (item.pid in map) {
      // id å¤„ç†æˆå¯¹è±¡åï¼Œpai å¯¹åº”äº† id
      const parent = map[item.pid]
      parent.children = parent.children || []
      parent.children.push(item)
    }
  }

  return result
}
```

### 4. map çš„æ–¹å¼ ä»£æ›¿ object

```js
// key ç›¸åŒ ï¼Œåé¢çš„ä¼šè¦†ç›–å‰é¢çš„
function mapConvert(list) {
  const result = []
  // å¤§æ•°æ®æƒ…å†µä¸‹ï¼Œè¿™è¾¹ä¼šæŸ¥æ‰¾æ›´å¿«ï¼Œæ•°ç»„çš„æ•ˆç‡ä¼šæ¯”è¾ƒæ…¢
  const map = new Map()
  list.forEach((item) => {
    map.set(item.id, item)
  })

  for (const item of list) {
    if (item.pid === 0) {
      result.push(item)
      continue
    }
    if (map.has(item.pid)) {
      const parent = map.get(item.pid)

      parent.children = parent.children || []

      parent.children.push(item)
    }
  }

  return result
}
```

## åå‘æ“ä½œ --> JSON æ ‘è½¬æ‰å¹³æ•°ç»„

```js
function treeToArr(data) {
  return data.reduce((pre, cur) => {
    const { id, value, pid, children = [] } = cur
    return pre.concat([{ id, value, pid }], treeToArr(children))
  }, [])
}
```

```js
function treeToArr1(data) {
  const result = []
  data.forEach((item) => {
    const { id, value, pid, children = [] } = item
    result.push({ id, value, pid }, ...treeToArr(children))
  })
  return result
}
```

---

æœ€åï¼Œä¸€ä»¶äº‹ï¼Œå°±æ˜¯å‘Šè¯«ä¸‹è‡ªå·±ï¼Œåšäº‹ä¸€å®šè¦è¸å®
